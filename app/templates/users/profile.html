{% extends 'base.html' %}

{% block title %}{{ user.username }}{% endblock %}

{% block content %}
<div class="row g-4">
    <div class="col-md-4">
        <div class="card profile-card text-center mb-4">
            <div class="card-body">
                <img src="{{ user.pfp_url or 'https://i.pravatar.cc/150?u=' ~ user.username }}" alt="Foto de {{ user.username }}" class="profile-pfp">
                <h2 class="mt-3">{{ user.username }}</h2>
                <p class="text-muted">Membro desde {{ user.created_at.strftime('%b de %Y') }}</p>

                {% if g.user.id != user.id %}
                    {% if friendship_status == 'none' %}
                        <form action="{{ url_for('main.send_friend_request', user_id=user.id) }}" method="POST">
                            <button type="submit" class="btn btn-primary w-100"><i class="bi bi-person-plus-fill"></i> Adicionar Amigo</button>
                        </form>
                    {% elif friendship_status == 'pending_sent' %}
                        <button class="btn btn-secondary w-100" disabled><i class="bi bi-hourglass-split"></i> Pedido Enviado</button>
                    {% elif friendship_status == 'pending_received' %}
                        <div class="d-flex gap-2">
                            <form action="{{ url_for('main.respond_to_friend_request', requester_id=user.id, action='accept') }}" method="POST" class="w-100">
                                <button type="submit" class="btn btn-success w-100"><i class="bi bi-check-lg"></i> Aceitar</button>
                            </form>
                            <form action="{{ url_for('main.respond_to_friend_request', requester_id=user.id, action='reject') }}" method="POST" class="w-100">
                                <button type="submit" class="btn btn-danger w-100"><i class="bi bi-x-lg"></i> Rejeitar</button>
                            </form>
                        </div>
                    {% elif friendship_status == 'friends' %}
                         <button class="btn btn-success w-100" disabled><i class="bi bi-people-fill"></i> Amigos</button>
                    {% endif %}
                {% else %}
                    <a href="{{ url_for('main.edit_profile') }}" class="btn btn-secondary w-100"><i class="bi bi-pencil-fill"></i> Editar Perfil</a>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header fw-bold">Amigos ({{ friends|length }})</div>
            <div class="list-group list-group-flush">
                {% for friend in friends %}
                    <a href="{{ url_for('main.profile', username=friend.username) }}" class="list-group-item list-group-item-action d-flex align-items-center gap-3">
                        <img src="{{ friend.pfp_url }}" alt="Foto de {{ friend.username }}" class="friend-pfp">
                        <span>{{ friend.username }}</span>
                    </a>
                {% else %}
                    <li class="list-group-item">Nenhum amigo para mostrar.</li>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-body">
                <h4 class="text-primary">Biografia</h4>
                <p class="lead">{{ user.bio or 'Este usuário ainda não escreveu uma biografia.' }}</p>
            </div>
        </div>

        {% if friend_requests %}
        <div class="card mb-4">
            <div class="card-header fw-bold">
                <i class="bi bi-bell-fill text-warning"></i> Pedidos de Amizade Pendentes
            </div>
            <div class="list-group list-group-flush">
                {% for req in friend_requests %}
                <div class="list-group-item d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <a href="{{ url_for('main.profile', username=req.username) }}" class="d-flex align-items-center text-decoration-none text-white">
                        <img src="{{ req.pfp_url }}" alt="Foto de {{ req.username }}" class="friend-pfp me-2">
                        <span class="fw-bold">{{ req.username }}</span>
                    </a>
                    <div class="d-flex gap-2">
                        <form action="{{ url_for('main.respond_to_friend_request', requester_id=req.id, action='accept') }}" method="POST">
                            <button type="submit" class="btn btn-sm btn-success"><i class="bi bi-check-lg"></i> Aceitar</button>
                        </form>
                        <form action="{{ url_for('main.respond_to_friend_request', requester_id=req.id, action='reject') }}" method="POST">
                            <button type="submit" class="btn btn-sm btn-danger"><i class="bi bi-x-lg"></i> Rejeitar</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="card">
             <div class="card-header fw-bold">
                <i class="bi bi-clock-history"></i> Atividade Recente
             </div>
             <div class="list-group list-group-flush">
                {% for r in reservations %}
                    <a href="{{ url_for('main.book_detail', book_id=r.book_id) }}" class="list-group-item list-group-item-action d-flex align-items-center gap-3">
                        <img 
                            src="{{ r.cover_image_url or 'https://via.placeholder.com/50x75.png?text=Capa' }}" 
                            alt="Capa de {{ r.title }}" 
                            style="width: 50px; height: 75px; object-fit: cover; border-radius: 4px;">
                        <div>
                            <p class="mb-0 fw-bold">{{ r.title }}</p>
                            <small class="text-muted">Reservado em {{ r.reservation_date.strftime('%d/%m/%Y') }}</small>
                        </div>
                    </a>
                {% else %}
                    <div class="list-group-item">
                        Nenhuma atividade de reserva recente.
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}